<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Player Manager</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">

  <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.5/build/pure-min.css"
    integrity="sha384-LTIDeidl25h2dPxrB2Ekgc9c7sEC3CWGM6HeFmuDNUjX76Ert4Z4IY714dhZHPLd" crossorigin="anonymous">
  <link rel="stylesheet" href="stylesheets/justsome.css">

  <script defer src="/__/firebase/8.2.5/firebase-app.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-auth.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-database.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-storage.js"></script>

  <script defer src="/__/firebase/init.js?useEmulator=true"></script>

  <style>
    #welcomeMsg {
      text-align: center;
      width: 100%;
    }

    /* table css */

    /* .tableContainer {
      overflow-x: auto;
    } */

    table {
      width: 100%;
    }

    /* th:nth-child(1) {
      width: 100px;
    }

    th:nth-child(2) {
      width: 200px;
    }

    th:nth-child(3) {
      width: 300px;
    } */
  </style>

</head>

<body>

  <header>
    <section>
      <img class="pure-img" src="assets/CVRE.png">
      <h1>Player Manager</h1>
    </section>
    <button type="button" id="logoutButton" class="pure-button">Logout</button>
  </header>
  <main class="pure-g">
    <h1 id="welcomeMsg" class="pure-u-1">Welcome!</h1>
    <div class="pure-u-1-2 pure-g">
      <form id="captainInfoForm" class="pure-u-1 pure-form pure-form-aligned">
        <fieldset>
          <legend>Captain Information</legend>
          <div class="pure-control-group">
            <label for="discordInput">Discord Username</label>
            <input type="text" id="discordInput" placeholder="Wumpus#0001" required="">
          </div>
          <div class="pure-controls">
            <button type="submit" class="pure-button pure-button-primary">Save</button>
          </div>
        </fieldset>
      </form>
      <form id="createOrgForm" class="pure-u-1 pure-form pure-form-aligned">
        <fieldset disabled>
          <legend>Create New Organization</legend>
          <div class="pure-control-group">
            <label for="orgNameInput">Organization Name</label>
            <input type="text" id="orgNameInput" placeholder="School of Hard Knocks" required="">
          </div>
          <div class="pure-control-group">
            <label for="orgLogoInput">Organization Logo</label>
            <input type="file" id="orgLogoInput" required="">
          </div>
          <div class="pure-controls">
            <button type="submit" class="pure-button pure-button-primary">Save</button>
          </div>
        </fieldset>
      </form>
      <form id="createTeamForm" class="pure-u-1 pure-form pure-form-aligned">
        <fieldset disabled>
          <legend>Create New Team</legend>
          <div class="pure-control-group">
            <label for="teamOrgSelect">Team Organization</label>
            <select id="teamOrgSelect">
              <option value="false">No Organizations!</option>
            </select>
          </div>
          <div class="pure-control-group">
            <label for="teamGameSelect">Team Game</label>
            <select id="teamGameSelect">
              <option value="Beat Saber">Beat Saber</option>
              <option value="Echo Arena">Echo Arena</option>
            </select>
          </div>
          <div class="pure-control-group">
            <label for="teamNameInput">Team Name</label>
            <input type="text" id="teamNameInput" placeholder="The Rockin' Randos" required="">
          </div>
          <div class="pure-controls">
            <button type="submit" class="pure-button pure-button-primary">Save</button>
          </div>
        </fieldset>
      </form>
      <form id="createPlayerForm" class="pure-u-1 pure-form pure-form-aligned">
        <fieldset disabled>
          <legend>Create New Player</legend>
          <div class="pure-control-group">
            <label for="playerOrgSelect">Player Organization</label>
            <select id="playerOrgSelect">
              <option value="false">No Organizations!</option>
            </select>
          </div>
          <div class="pure-control-group">
            <label for="playerTeamSelect">Player Team</label>
            <select id="playerTeamSelect">
              <option value="false">Select an organization!</option>
            </select>
          </div>
          <div class="pure-control-group">
            <label for="playerNameInput">Player Name</label>
            <input type="text" id="playerNameInput" placeholder="Randy" required="">
          </div>
          <div class="pure-control-group">
            <label for="playerEmailInput">Player Email</label>
            <input type="email" id="playerEmailInput" placeholder="randy3@uni.edu" required="">
          </div>
          <div class="pure-control-group">
            <label for="playerImageInput">Verification Image</label>
            <input type="file" id="playerImageInput" required="">
          </div>
          <div class="pure-controls">
            <button type="submit" class="pure-button pure-button-primary">Save</button>
          </div>
        </fieldset>
      </form>
    </div>
    <div class="pure-u-1-2">
      <!-- <div class="tableContainer"> -->
        <table class="pure-table">
          <thead>
            <tr>
              <th>Org</th>
              <th>Team</th>
              <th>Game</th>
              <th>Player Name</th>
              <th>Email</th>
              <th>Verification Image</th>
              <th>Verified</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="7">Nothing yet!</td>
            </tr>
          </tbody>
        </table>
      <!-- </div> -->
    </div>
  </main>
  <footer>
    <section class="pure-u-1-2 logoContainer">
      <a href="http://discord.gg/JXbmZjp"><img class="pure-img discordLogo" src="assets/Discord-Logo-White.png"></a>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", function () {

      const auth = firebase.auth();
      const db = firebase.database();
      const stor = firebase.storage();
      var currentUser;
      var currentUserData;

      auth.onAuthStateChanged(function (user) {
        if (!user) {
          window.location.replace("/");
        } else {
          currentUser = user;
          db.ref(currentUser.uid).once("value").then((snapshot) => {
            currentUserData = snapshot.val();
            if (!currentUserData) {
              currentUserData = {};
            } else {
              document.getElementById("discordInput").placeholder = currentUserData.discord;
              if (currentUserData.approved) {
                let sets = document.getElementsByTagName("fieldset");
                for (const elem of sets) {
                  elem.removeAttribute("disabled");
                }
              }
            }
          });
        }
      });

      document.getElementById("logoutButton").addEventListener("click", function (event) {
        event.preventDefault();
        auth.signOut()
          .catch((error) => {
            alert(error.message);
          });
      });

      const discordRegex = /^[^@#:`]{2,32}#\d{4}$/u;

      const captainInfoForm = document.getElementById("captainInfoForm");
      const discordInput = document.getElementById("discordInput");

      captainInfoForm.addEventListener("submit", function (event) {
        event.preventDefault();
        let discordAttempt = discordInput.value;
        if (discordRegex.test(discordAttempt)) {
          db.ref(currentUser.uid).update({
            discord: discordAttempt,
          });
          discordInput.placeholder = discordAttempt;
          currentUserData.discord = discordAttempt;
          captainInfoForm.reset();
        } else {
          alert("Discord username is badly formatted.");
        }
      });

      //   const createOrgForm = document.getElementById("createOrgForm");

      //   const orgNameInput = document.getElementById("orgNameInput");
      //   const orgLogoInput = document.getElementById("orgLogoInput");

      //   createOrgForm.addEventListener("submit", function (event) {
      //     event.preventDefault();
      //     let orgNameAttempt = orgNameInput.value;
      //     let orgLogoAttempt = orgLogoInput.files[0];
      //     let currentOrgList = (typeof (currentUserData["orgList"]) !== "undefined") ? currentUserData["orgList"] : [];
      //     currentOrgList.push(orgNameAttempt);
      //     db.ref(currentUser.uid).update({
      //       orgList: currentOrgList,
      //     });
      //     stor.ref(currentUser.uid).child("orgLogos/" + orgNameAttempt).put(orgLogoAttempt);
      //     currentUserData["orgList"] = currentOrgList;
      //     console.log(currentUserData["orgList"]);
      //     createOrgForm.reset();
      //   });

      //   const createTeamForm = document.getElementById("createTeamForm");

      //   const teamOrgSelect = document.getElementById("teamOrgSelect");
      //   const teamGameSelect = document.getElementById("teamGameSelect");
      //   const teamNameInput = document.getElementById("teamNameInput");

      //     // let newOptions = "";
      //     // for (const org of currentUserData["orgList"]) {
      //     //   newOptions += "<option value=\"" + org + "\">" + org + "</option>";
      //     // }
      //     // teamOrgSelect.innerHTML = newOptions;

      //   createTeamForm.addEventListener("submit", function (event) {
      //     event.preventDefault();
      //     // let teamOrg = teamOrgSelect.value;
      //     // let teamGame = teamGameSelect.value;
      //     // let teamNameAttempt = teamNameInput.value;
      //     // if (teamOrg !== "false") {
      //     //   db.ref(currentUser.uid + "/" + teamGame + "/" + teamOrg + "/" + teamNameAttempt).update({
      //     //     players: false,
      //     //   });
      //     //   currentUserData[teamGame] = { [teamOrg]: { [teamNameAttempt]: false } };
      //     //   createTeamForm.reset();
      //     // } else {
      //     //   alert("You must have at least one organization before you can create teams!")
      //     // }
      //   });

      //   const eduRegex = /(\.edu)$/i;

      //   const createPlayerForm = document.getElementById("createPlayerForm");

      //   const playerOrgSelect = document.getElementById("playerOrgSelect");
      //   const playerTeamSelect = document.getElementById("playerTeamSelect");
      //   const playerNameInput = document.getElementById("playerNameInput");
      //   const playerEmailInput = document.getElementById("playerEmailInput");
      //   const playerImageInput = document.getElementById("playerImageInput");


      //     //   let newOptions = "";
      //     //   for (const org of currentUserData["orgList"]) {
      //     //     newOptions += "<option value=\"" + org + "\">" + org + "</option>";
      //     //   }
      //     //   playerOrgSelect.innerHTML = newOptions;
      //     //   newOptions = "";
      //     //   try {
      //     //     for (const team in currentUserData["Beat Saber"][playerOrgSelect.value]) {
      //     //       newOptions += "<option value=\"Beat Saber/" + playerOrgSelect.value + "/" + team + "\">Beat Saber: " + team + "</option>";
      //     //     }
      //     //   } catch (err) { }
      //     //   try {
      //     //     for (const team in currentUserData["Echo Arena"][playerOrgSelect.value]) {
      //     //       newOptions += "<option value=\"Echo Arena/" + playerOrgSelect.value + "/" + team + "\">Echo Arena: " + team + "</option>";
      //     //     }
      //     //   } catch (err) { }
      //     //   if (newOptions) {
      //     //     playerTeamSelect.innerHTML = newOptions;
      //     //   } else {
      //     //     playerTeamSelect.innerHTML = "<option value=\"false\">No Teams!</option>"
      //     //   }

      //   playerOrgSelect.addEventListener("change", function (event) {
      //     // let newOptions = "";
      //     // try {
      //     //   for (const team in currentUserData["Beat Saber"][playerOrgSelect.value]) {
      //     //     newOptions += "<option value=\"Beat Saber/" + playerOrgSelect.value + "/" + team + "\">Beat Saber: " + team + "</option>";
      //     //   }
      //     // } catch (err) { }
      //     // try {
      //     //   for (const team in currentUserData["Echo Arena"][playerOrgSelect.value]) {
      //     //     newOptions += "<option value=\"Echo Arena/" + playerOrgSelect.value + "/" + team + "\">Echo Arena: " + team + "</option>";
      //     //   }
      //     // } catch (err) { }
      //     // if (newOptions) {
      //     //   playerTeamSelect.innerHTML = newOptions;
      //     // } else {
      //     //   playerTeamSelect.innerHTML = "<option value=\"false\">No Teams!</option>"
      //     // }
      //   });

      //   createPlayerForm.addEventListener("submit", function (event) {
      //     event.preventDefault();
      //     // let playerOrg = playerOrgSelect.value;
      //     // let playerTeam = playerTeamSelect.value;
      //     // let playerNameAttempt = playerNameInput.value;
      //     // let playerEmailAttempt = playerEmailInput.value;
      //     // let playerImageAttempt = playerImageInput.files[0];
      //     // if (playerOrg !== "false") {
      //     //   if (playerTeam !== "false") {
      //     //     if (eduRegex.test(playerEmailAttempt)) {
      //     //       console.log(currentUserData[playerTeam]);
      //     //       // db.ref(currentUser.uid + "/" + playerTeam + "/" )
      //     //     } else {
      //     //       alert("Please provide a player email ending in \".edu\"");
      //     //     }
      //     //   } else {
      //     //     alert("You must have at least one team before you can create players!")
      //     //   }
      //     // } else {
      //     //   alert("You must have at least one organization before you can create players!")
      //     // }

      //   });

    });
  </script>
</body>

</html>