<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CVRE Player Manager</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">

  <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.5/build/pure-min.css"
    integrity="sha384-LTIDeidl25h2dPxrB2Ekgc9c7sEC3CWGM6HeFmuDNUjX76Ert4Z4IY714dhZHPLd" crossorigin="anonymous">
  <link rel="stylesheet" href="stylesheets/justsome.css">

  <script defer src="/__/firebase/8.2.5/firebase-app.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-auth.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-database.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-storage.js"></script>

  <script defer src="/__/firebase/init.js?useEmulator=true"></script>

  <style>
    h1 {
      text-align: center;
      width: 100%;
    }
  </style>

</head>

<body>

  <header>
    <section>
      <img class="pure-img" src="assets/CVRE.png">
      <h1>Player Manager</h1>
    </section>
    <button id="logoutButton" class="pure-button">Logout</button>
  </header>
  <main>
    <h1>Welcome!</h1>
    <row class="pure-g">
      <card class="pure-u-1-2 PUTTHECONTENTINTHEMIDDLE">
        <form id="discordForm" class="pure-form pure-form-aligned">
          <fieldset>
            <div class="pure-control-group">
              <label for="discordInput">Discord Username</label>
              <input type="text" id="discordInput" placeholder="Wumpus#0001" required="">
            </div>
            <div class="pure-controls">
              <button type="submit" class="pure-button pure-button-primary">Save</button>
            </div>
          </fieldset>
        </form>
      </card>
      <card class="pure-u-1-2 PUTTHECONTENTINTHEMIDDLE">
        <form class="pure-form pure-form-aligned">
          <fieldset>
            <div class="pure-control-group">
              <label for="orgNameInput">Organization Name</label>
              <input type="text" id="orgNameInput" placeholder="School of Hard Knocks" required="" disabled="">
            </div>
            <div class="pure-control-group">
              <label for="logoInput">Organization Logo</label>
              <input type="file" id="logoInput" required="" disabled="">
            </div>
            <div class="pure-controls">
              <button type="submit" id="orgSubmitButton" class="pure-button pure-button-primary" disabled="">Save</button>
            </div>
          </fieldset>
        </form>
      </card>
    </row>
    <row class="pure-g">
      <card class="pure-u-1-2"></card>
      <card class="pure-u-1-2"></card>
    </row>
  </main>
  <footer>
    <section class="pure-u-1-2 logoContainer">
      <a href="http://discord.gg/JXbmZjp"><img class="pure-img discordLogo" src="assets/Discord-Logo-White.png"></a>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", function () {

      const auth = firebase.auth();
      const db = firebase.database();
      var currentUser;
      var currentUserData;

      auth.onAuthStateChanged(function (user) {
        if (!user) {
          window.location.replace("/");
        } else {
          currentUser = user;
          db.ref(currentUser.uid).once("value").then((snapshot) => {
            currentUserData = snapshot.val();
              document.getElementById("discordInput").placeholder = currentUserData.discord;
            if (currentUserData.approved) {
              docuement.getElementById("orgNameInput").removeAttribute("disabled");
              docuement.getElementById("logoInput").removeAttribute("disabled");
              docuement.getElementById("orgSubmitButton").removeAttribute("disabled");
            }
          });
        }
      });

      document.getElementById("logoutButton").addEventListener("click", function (event) {
        event.preventDefault();
        auth.signOut()
          .catch((error) => {
            alert(error.message);
          });
      });

      const discordRegex = /^[^@#:`]{2,32}#\d{4}$/u;
      const discordForm = document.getElementById("discordForm");
      const discordInput = document.getElementById("discordInput");

      discordForm.addEventListener("submit", function (event) {
        event.preventDefault();
        let discordAttempt = discordInput.value;
        if (discordRegex.test(discordAttempt)) {
          db.ref(currentUser.uid).update({
            discord: discordAttempt,
          });
          discordForm.reset();
          discordInput.placeholder = discordAttempt;
        } else {
          alert("Discord username is badly formatted.");
        }
      });

    });
  </script>
</body>

</html>