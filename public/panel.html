<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Player Manager</title>
  <link rel="icon" type="image/png" href="assets/favicon.png">

  <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.5/build/pure-min.css"
    integrity="sha384-LTIDeidl25h2dPxrB2Ekgc9c7sEC3CWGM6HeFmuDNUjX76Ert4Z4IY714dhZHPLd" crossorigin="anonymous">
  <link rel="stylesheet" href="stylesheets/justsome.css">

  <script defer src="/__/firebase/8.2.5/firebase-app.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-auth.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-database.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-storage.js"></script>

  <script defer src="/__/firebase/init.js?useEmulator=true"></script>

  <style>
    .centerwide {
      text-align: center;
      width: 100%;
    }

    /* table css */

    /* .tableContainer {
      overflow-x: auto;
    } */

    table {
      /* width: 100%; */
      display: block;
      max-width: fit-content;
      margin: 0 auto;
      overflow-x: auto;
    }

    /* @media (min-width: 100rem) { */
    main {
      margin-left: 3rem;
      margin-right: 3rem;
    }

    /* }  */

    /* th:nth-child(1) {
      width: 100px;
    }

    th:nth-child(2) {
      width: 200px;
    }

    th:nth-child(3) {
      width: 300px;
    } */

    form {
      max-width: fit-content;
      margin: 0rem auto;
    }

    a {
      background-color: #FFFFFF;
      color: #000000;
      text-decoration: none
    }
  </style>

</head>

<body>

  <header>
    <section>
      <img class="pure-img" src="assets/CVRE.png">
      <h1>Player Manager</h1>
    </section>
    <button type="button" id="logoutButton" class="pure-button">Logout</button>
  </header>
  <main>
    <h1 id="welcomeMsg" class="centerwide">Welcome!</h1>
    <p class="centerwide">Click on a(n) org/team/player name to delete it.<br>Creating a(n) org/team/player with the
      same name as another in the same location <span style="font-weight: bold;">will</span> overwrite the previous.</p>
    <div class="pure-g">
      <form id="captainInfoForm" class="pure-form pure-form-aligned pure-u-1-2">
        <fieldset>
          <legend>Captain Information</legend>
          <div class="pure-control-group">
            <label for="discordInput">Discord Username</label>
            <input type="text" id="discordInput" placeholder="Wumpus#0001" required="">
          </div>
          <div class="pure-controls">
            <button type="submit" class="pure-button pure-button-primary">Save</button>
          </div>
        </fieldset>
      </form>
      <form id="createOrgForm" class="pure-form pure-form-aligned pure-u-1-2">
        <fieldset id="orgSet" disabled>
          <legend>Create New Organization</legend>
          <div class="pure-control-group">
            <label for="orgNameInput">Organization Name</label>
            <input type="text" id="orgNameInput" placeholder="School of Hard Knocks" required="">
          </div>
          <div class="pure-control-group">
            <label for="orgLogoInput">Organization Logo</label>
            <input type="file" id="orgLogoInput" required="">
          </div>
          <div class="pure-controls">
            <button type="submit" class="pure-button pure-button-primary">Save</button>
          </div>
        </fieldset>
      </form>
      <form id="createTeamForm" class="pure-form pure-form-aligned pure-u-1-2">
        <fieldset id="teamSet" disabled>
          <legend>Create New Team</legend>
          <div class="pure-control-group">
            <label for="teamOrgSelect">Team Organization</label>
            <select id="teamOrgSelect">
              <option value="false">No Organizations!</option>
            </select>
          </div>
          <div class="pure-control-group">
            <label for="teamGameSelect">Team Game</label>
            <select id="teamGameSelect">
              <option value="Beat Saber">Beat Saber</option>
              <option value="Echo Arena">Echo Arena</option>
            </select>
          </div>
          <div class="pure-control-group">
            <label for="teamNameInput">Team Name</label>
            <input type="text" id="teamNameInput" placeholder="The Rockin' Randos" required="">
          </div>
          <div class="pure-controls">
            <button type="submit" class="pure-button pure-button-primary">Save</button>
          </div>
        </fieldset>
      </form>
      <form id="createPlayerForm" class="pure-form pure-form-aligned pure-u-1-2">
        <fieldset id="playerSet" disabled>
          <legend>Create New Player</legend>
          <div class="pure-control-group">
            <label for="playerOrgSelect">Player Organization</label>
            <select id="playerOrgSelect">
              <option value="false">No Organizations!</option>
            </select>
          </div>
          <div class="pure-control-group">
            <label for="playerTeamSelect">Player Team</label>
            <select id="playerTeamSelect">
              <option value="false">Select an organization!</option>
            </select>
          </div>
          <div class="pure-control-group">
            <label for="playerNameInput">Player Name</label>
            <input type="text" id="playerNameInput" placeholder="Randy" required="">
          </div>
          <div class="pure-control-group">
            <label for="playerEmailInput">Player Email</label>
            <input type="email" id="playerEmailInput" placeholder="randy3@uni.edu" required="">
          </div>
          <div class="pure-control-group">
            <label for="playerImageInput">Verification Image</label>
            <input type="file" id="playerImageInput" required="">
          </div>
          <div class="pure-controls">
            <button type="submit" class="pure-button pure-button-primary">Save</button>
          </div>
        </fieldset>
      </form>
    </div>
    <div>
      <table class="pure-table">
        <thead>
          <tr>
            <th>Org</th>
            <th>Game</th>
            <th>Team</th>
            <th>Player Name</th>
            <th>Email</th>
            <th>Verification Image</th>
            <th>Verified</th>
          </tr>
        </thead>
        <tbody id="theBOD">
          <tr>
            <td colspan="7">Nothing yet!</td>
          </tr>
        </tbody>
      </table>
      <!-- </div> -->
    </div>
  </main>
  <footer>
    <section class="pure-u-1-2 logoContainer">
      <a href="http://discord.gg/JXbmZjp"><img class="pure-img discordLogo" src="assets/Discord-Logo-White.png"></a>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", function () {

      const auth = firebase.auth();
      const db = firebase.database();
      const stor = firebase.storage();
      var currentUser;
      var currentUserData;

      const teamOrgSelect = document.getElementById("teamOrgSelect");
      const playerOrgSelect = document.getElementById("playerOrgSelect");

      function appendTD(parent, text) {
        let td = document.createElement("td");
        td.appendChild(document.createTextNode(text));
        return parent.appendChild(td);
      }

      function itstimetorrrrrrremove(org, game, team, player) {
        if (player) {
          if (Object.keys(currentUserData["roster"][org][game][team]["players"]).length === 1) {
            db.ref(currentUser.uid + "/roster/" + org + "/" + game + "/" + team).update({
              players: false,
            })
            currentUserData["roster"][org][game][team]["players"] = false;
          } else {
            db.ref(currentUser.uid + "/roster/" + org + "/" + game + "/" + team + "/players").update({
              [player]: null,
            })
            delete currentUserData["roster"][org][game][team]["players"][player];
          }
        } else if (team) {
          if (Object.keys(currentUserData["roster"][org][game]).length === 1 && Object.keys(currentUserData["roster"][org]).length === 1) {
            db.ref(currentUser.uid + "/roster").update({
              [org]: false,
            })
            currentUserData["roster"][org] = false;
          } else {
            db.ref(currentUser.uid + "/roster/" + org + "/" + game).update({
              [team]: null,
            })
            delete currentUserData["roster"][org][game][team];
          }
        } else if (org) {
          if (Object.keys(currentUserData["roster"]).length === 1) {
            db.ref(currentUser.uid).update({
              roster: false,
            })
            currentUserData["roster"] = false;
          } else {
            db.ref(currentUser.uid + "/roster").update({
              [org]: null,
            })
            delete currentUserData["roster"][org];
          }
        }
        generateTable();
      }

      function generateTable() {
        let roster = currentUserData["roster"];
        let tableBod = document.getElementById("theBOD");
        if (roster) {
          tableBod.innerHTML = "";
          for (let orgIndex = 0; orgIndex < Object.keys(roster).length; orgIndex++) {
            let org = Object.keys(roster)[orgIndex];
            let tr = document.createElement("tr");
            td = document.createElement("td");
            let link = document.createElement("a");
            link.setAttribute("href", "#");
            link.setAttribute("title", "Click to delete.");
            link.appendChild(document.createTextNode(org));
            link.addEventListener("click", function (event) {
              itstimetorrrrrrremove(org, false, false, false)
            });
            td.appendChild(link);
            tr.appendChild(td);
            for (let gameIndex = 0; gameIndex < Object.keys(roster[org]).length; gameIndex++) {
              let game = Object.keys(roster[org])[gameIndex];
              if (gameIndex !== 0) {
                tableBod.appendChild(tr);
                tr = document.createElement("tr");
                appendTD(tr, "");
              }
              appendTD(tr, game);
              for (let teamIndex = 0; teamIndex < Object.keys(roster[org][game]).length; teamIndex++) {
                let team = Object.keys(roster[org][game])[teamIndex];
                if (teamIndex !== 0) {
                  tableBod.appendChild(tr);
                  tr = document.createElement("tr");
                  appendTD(tr, "");
                  appendTD(tr, "");
                }
                td = document.createElement("td");
                let link = document.createElement("a");
                link.setAttribute("href", "#");
                link.setAttribute("title", "Click to delete.");
                link.appendChild(document.createTextNode(team));
                link.addEventListener("click", function (event) {
                  itstimetorrrrrrremove(org, game, team, false)
                });
                td.appendChild(link);
                tr.appendChild(td);
                for (let playerIndex = 0; playerIndex < Object.keys(roster[org][game][team]["players"]).length; playerIndex++) {
                  let player = Object.keys(roster[org][game][team]["players"])[playerIndex];
                  if (playerIndex !== 0) {
                    tableBod.appendChild(tr);
                    tr = document.createElement("tr");
                    appendTD(tr, "");
                    appendTD(tr, "");
                    appendTD(tr, "");
                  }
                  td = document.createElement("td");
                  link = document.createElement("a");
                  link.setAttribute("href", "#");
                  link.setAttribute("title", "Click to delete.");
                  link.appendChild(document.createTextNode(player));
                  link.addEventListener("click", function (event) {
                    itstimetorrrrrrremove(org, game, team, player)
                  });
                  td.appendChild(link);
                  tr.appendChild(td);
                  appendTD(tr, roster[org][game][team]["players"][player]["email"]);
                  appendTD(tr, "image?");
                  // appendTD(tr, roster[org][game][team]["players"][player]["verified"])
                  td = document.createElement("td");
                  let span = document.createElement("span");
                  if (roster[org][game][team]["players"][player]["verified"]) {
                    span.setAttribute("style", "color:green;font-weight:bold;")
                    span.appendChild(document.createTextNode("YES"));
                  } else {
                    span.setAttribute("style", "color:red;font-weight:bold;")
                    span.appendChild(document.createTextNode("NO"));
                  }
                  td.appendChild(span);
                  tr.appendChild(td);
                }
              }
            }
            tableBod.appendChild(tr);
          }
        } else {
          tableBod.innerHTML = "<tr><td colspan=\"7\">Nothing yet!</td></tr>"
        }
      }

      function refreshOrgSelects() {
        if (currentUserData["roster"]) {
          teamOrgSelect.innerHTML = "";
          playerOrgSelect.innerHTML = "";
          for (let org in currentUserData["roster"]) {
            let option = document.createElement("option");
            option.appendChild(document.createTextNode(org));
            option.setAttribute("value", org);
            playerOrgSelect.appendChild(option);

            option = document.createElement("option");
            option.appendChild(document.createTextNode(org));
            option.setAttribute("value", org);
            teamOrgSelect.appendChild(option);
          }
        } else {
          teamOrgSelect.innerHTML = "<option value=\"false\">No Organizations!</option>";
          playerOrgSelect.innerHTML = "<option value=\"false\">No Organizations!</option>";
        }
      }
      function refreshTeamSelects() {
        if (playerOrgSelect.value) {
          let selectTeamInner = "";
          // for (let team in currentUserData["roster"][playerOrgSelect.value]) {
          //   selectTeamInner += "<option value=\"Beat Saber/" + team + "\">" + currentUserData["roster"][playerOrgSelect.value][team]["game"] + ": " + team + "</option>";
          // }
          for (let game in currentUserData["roster"][playerOrgSelect.value]) {
            for (let team in currentUserData["roster"][playerOrgSelect.value][game]) {
              selectTeamInner += "<option value=\"" + game + "/" + team + "\">" + game + ": " + team + "</option>";
            }
          }
          if (selectTeamInner === "") {
            playerTeamSelect.innerHTML = "<option value=\"false\">No Teams!</option>";
          } else {
            playerTeamSelect.innerHTML = selectTeamInner;
          }
        } else {
          playerTeamSelect.innerHTML = "<option value=\"false\">Select an organization!</option>";
        }
      }

      auth.onAuthStateChanged(function (user) {
        if (!user) {
          window.location.replace("/");
        } else {
          currentUser = user;
          db.ref(currentUser.uid).once("value").then((snapshot) => {
            currentUserData = snapshot.val();
            if (!currentUserData) {
              db.ref(currentUser.uid).update({
                roster: false,
              })
              currentUserData = { "roster": false, };
              document.getElementById("welcomeMsg").innerHTML += " You will not be able to manage your roster until your account is reviewed and approved. Please be patient.";
            } else {
              document.getElementById("discordInput").placeholder = currentUserData.discord;
              if (currentUserData.approved) {
                document.getElementById("orgSet").removeAttribute("disabled");
                document.getElementById("teamSet").removeAttribute("disabled");
                document.getElementById("playerSet").removeAttribute("disabled");
              } else {
                document.getElementById("welcomeMsg").innerHTML += " You will not be able to manage your roster until your account is reviewed and approved. Please be patient.";
              }
            }
            refreshOrgSelects();
            refreshTeamSelects();
            generateTable();
          });
        }
      });

      document.getElementById("logoutButton").addEventListener("click", function (event) {
        event.preventDefault();
        auth.signOut()
          .catch((error) => {
            alert(error.message);
          });
      });

      const discordRegex = /^[^@#:`]{2,32}#\d{4}$/u;

      const captainInfoForm = document.getElementById("captainInfoForm");
      const discordInput = document.getElementById("discordInput");

      captainInfoForm.addEventListener("submit", function (event) {
        event.preventDefault();
        let discordAttempt = discordInput.value;
        if (discordRegex.test(discordAttempt)) {
          db.ref(currentUser.uid).update({
            discord: discordAttempt,
          });
          discordInput.placeholder = discordAttempt;
          currentUserData.discord = discordAttempt;
          captainInfoForm.reset();
        } else {
          alert("Discord username is badly formatted.");
        }
      });

      const createOrgForm = document.getElementById("createOrgForm");

      const orgNameInput = document.getElementById("orgNameInput");
      const orgLogoInput = document.getElementById("orgLogoInput");

      createOrgForm.addEventListener("submit", function (event) {
        event.preventDefault();
        let orgNameAttempt = orgNameInput.value;
        let orgLogoAttempt = orgLogoInput.files[0];
        db.ref(currentUser.uid + "/roster").update({
          [orgNameAttempt]: false,
        });
        stor.ref(currentUser.uid).child("orgLogos/" + orgNameAttempt).put(orgLogoAttempt);
        if (!currentUserData["roster"]) {
          currentUserData["roster"] = {};
        }
        currentUserData["roster"][orgNameAttempt] = false;
        createOrgForm.reset();
        refreshOrgSelects();
        generateTable();
      });

      const createTeamForm = document.getElementById("createTeamForm");

      const teamGameSelect = document.getElementById("teamGameSelect");
      const teamNameInput = document.getElementById("teamNameInput");

      createTeamForm.addEventListener("submit", function (event) {
        event.preventDefault();
        let teamOrg = teamOrgSelect.value;
        let teamGame = teamGameSelect.value;
        let teamNameAttempt = teamNameInput.value;
        if (teamOrg !== "false") {
          db.ref(currentUser.uid + "/roster/" + teamOrg + "/" + teamGame + "/" + teamNameAttempt).update({
            players: false,
            game: teamGame,
          });
          if (!currentUserData["roster"][teamOrg]) {
            currentUserData["roster"][teamOrg] = {};
          }
          if (!currentUserData["roster"][teamOrg][teamGame]) {
            currentUserData["roster"][teamOrg][teamGame] = {};
          }
          currentUserData["roster"][teamOrg][teamGame][teamNameAttempt] = { "players": false, "game": teamGame };
          createTeamForm.reset();
          refreshTeamSelects();
          generateTable();
        } else {
          alert("You must have at least one organization before you can create teams!")
        }
      });

      const eduRegex = /(\.edu)$/i;

      const createPlayerForm = document.getElementById("createPlayerForm");

      const playerTeamSelect = document.getElementById("playerTeamSelect");
      const playerNameInput = document.getElementById("playerNameInput");
      const playerEmailInput = document.getElementById("playerEmailInput");
      const playerImageInput = document.getElementById("playerImageInput");

      playerOrgSelect.addEventListener("change", function (event) {
        refreshTeamSelects();
      });

      createPlayerForm.addEventListener("submit", function (event) {
        event.preventDefault();
        let playerOrg = playerOrgSelect.value;
        let playerGameTeam = playerTeamSelect.value;
        let FFS = playerGameTeam.split("/");
        let playerTeam = FFS[1];
        let playerGame = FFS[0];
        let playerNameAttempt = playerNameInput.value;
        let playerEmailAttempt = playerEmailInput.value;
        let playerImageAttempt = playerImageInput.files[0];
        if (playerOrg !== "false") {
          if (playerTeam !== "false") {
            if (eduRegex.test(playerEmailAttempt)) {
              db.ref(currentUser.uid + "/roster/" + playerOrg + "/" + playerGame + "/" + playerTeam + "/players/" + playerNameAttempt).update({
                email: playerEmailAttempt,
                verified: false,
              });
              stor.ref(currentUser.uid).child("playerImgs/" + playerOrg + "/" + playerGame + "/" + playerTeam + "/" + playerNameAttempt).put(playerImageAttempt);
              if (!currentUserData["roster"][playerOrg][playerGame][playerTeam]["players"]) {
                currentUserData["roster"][playerOrg][playerGame][playerTeam]["players"] = {};
              }
              currentUserData["roster"][playerOrg][playerGame][playerTeam]["players"][playerNameAttempt] = { "email": playerEmailAttempt, "verified": false };
              createPlayerForm.reset();
              generateTable();
            } else {
              alert("Please provide a player email ending in \".edu\"");
            }
          } else {
            alert("You must have at least one team before you can create players!")
          }
        } else {
          alert("You must have at least one organization before you can create players!")
        }

      });

    });
  </script>
</body>

</html>