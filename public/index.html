<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CVRE Player Manager</title>

  <!-- update the version number as needed -->
  <script defer src="/__/firebase/8.2.5/firebase-app.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-auth.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-database.js"></script>
  <!-- <script defer src="/__/firebase/8.2.5/firebase-storage.js"></script> -->

  <script defer src="/__/firebase/init.js?useEmulator=true"></script>

  <style>
    * {
      vertical-align: baseline;
      font-weight: inherit;
      font-family: inherit;
      font-style: inherit;
      font-size: 100%;
      border: 0 none;
      outline: 0;
      padding: 0;
      margin: 0;
    }
  </style>
</head>

<body>

  <p id="welcomeMsg">Login to access options & manage your teams.</p>

  <div id="unLoggedPanel">
    <form style="display: inline;" id="loginForm">
      <label for="mailInput">Email Address:</label>
      <input id="mailInput" type="email" autocomplete="username">
      <label for="passInput">Password:</label>
      <input id="passInput" type="password" autocomplete="current-password"><br>
      <button type="submit" id="signinButton">Sign-in</button>
    </form>

    <button id="registerButton">Register</button>
    <button id="forgotButton">Forgot Password</button>
  </div>

  <div style="display: none;" id="loggedPanel">
    <button id="signoutButton">Sign-out</button>

    <p>Current Discord: <span style="font-weight: bold;" id="discordDisp">Still needs to be set.</span></p>

    <form id="discordForm">
      <label for="discordInput">Update Discord username:</label>
      <input id="discordInput" type="text">
      <input type="submit" value="Submit">
    </form>

  </div>

  <div style="display: none;" id="adminPanel">
    <p>Users awaiting approval:</p>
    <table id="pendUserTable">
      <tr>
        <th>Nobody!</th>
      </tr>
    </table>
  </div>

  <div style="display: none;" id="approvedPanel">
    <p>Current organization: <span style="font-weight: bold;" id="orgDisp">Still needs to be set.</span></p>

    <form id="orgForm">
      <label for="orgInput">Update organization name:</label>
      <input id="orgInput" type="text">
      <input type="submit" value="Submit">
    </form>

    <div id="currentTeamsPanel">
      <table id="BSTeamTable">
        <caption>Your Beat Saber Teams</caption>
        <tr>
          <th>Team</th>
          <th>Player</th>
          <th>Provided Image</th>
          <th>Verified</th>
        </tr>
        <tbody id="BSTeamTableBody">
          <tr>
            <td colspan="4">No teams!</td>
          </tr>
        </tbody>
      </table>
      <table id="EATeamTable">
        <caption>Your Echo Arena Teams</caption>
        <tr>
          <th>Team</th>
          <th>Player</th>
          <th>Provided Image</th>
          <th>Verified</th>
        </tr>
        <tbody id="EATeamTableBody">
          <tr>
            <td colspan="4">No teams!</td>
          </tr>
        </tbody>
      </table>
    </div>

    <button id="createTeamButton">Create New Team</button>

    <div style="display: none;" id="teamCreationPanel">
      <form id="teamCreationForm">
        <label for="gameSelect">Select game:</label>
        <select id="gameSelect">
          <option value="Beat Saber">Beat Saber</option>
          <option value="Echo Arena">Echo Arena</option>
        </select>
        <label for="teamNameInput">Team name:</label>
        <input id="teamNameInput" type="text">
        <button id="saveTeamButton">Save Team</button>
        <button id="teamCreationCancel">Cancel</button>
      </form>
    </div>
  </div>

  <div id="playerAddPanel">
    <p>Add player to team:</p>
    <form id="playerAddForm">
      <select id="teamSelect">
        <option>No teams yet!</option>
      </select>
      <label for="playerNameAddInput">New player name:</label>
      <input id="playerNameAddInput" type="text">
      <button id="savePlayerButton" type="submit">Save Player</button>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {

      const auth = firebase.auth();
      const db = firebase.database();
      // const stor = firebase.storage();
      var currentUser;
      var currentUserData;

      const alphaNumRegex = /^[a-z0-9\s]+$/i;

      auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
        .catch((error) => {
          alert(error.message);
        });

      document.getElementById("registerButton").addEventListener("click", function (event) {
        auth.createUserWithEmailAndPassword(document.getElementById("mailInput").value, document.getElementById("passInput").value)
          .then((userCredential) => {
            db.ref(userCredential.user.uid).set({
              approved: false,
              admin: false,
            });
          })
          .catch((error) => {
            alert(error.message);
          });
      });

      document.getElementById("signinButton").addEventListener("click", function (event) {
        event.preventDefault();
        auth.signInWithEmailAndPassword(document.getElementById("mailInput").value, document.getElementById("passInput").value)
          .catch((error) => {
            alert(error.message);
          });
      });

      document.getElementById("forgotButton").addEventListener("click", function (event) {
        auth.sendPasswordResetEmail(document.getElementById("mailInput").value).then(function () {
          alert("Sent password reset email.");
        }).catch(function (error) {
          alert(error.message);
        });
      });

      document.getElementById("signoutButton").addEventListener("click", function (event) {
        auth.signOut()
          .catch((error) => {
            alert(error.message);
          });
      });

      function populateGameTable(dbSnapshotData, game, tableBodyID) {
        if (dbSnapshotData[game]) {
          let teams = dbSnapshotData[game];
          let gameTableBody = document.getElementById(tableBodyID);
          gameTableBody.innerHTML = "";
          for (const team in teams) {
            let rows = 0;
            let bodyTarget = "";
            if (teams[team] === "No players yet!") {
              rows = 1;
              bodyTarget = "<tr><td colspan=\"3\">No players yet!</td></tr>";
            } else {
              for (const player in teams[team]) {
                bodyTarget += "<tr><td>" + player + "</td><td>" + (teams[team][player].url ? teams[team][player].url : "Not provided.") + "</td><td>" + (teams[team][player].verified ? "Yes" : "No") + "</td></tr>";
                rows++;
              }
            }
            gameTableBody.innerHTML += [bodyTarget.slice(0, 4), "<td rowspan=" + rows + ">" + team + "</td>", bodyTarget.slice(4)].join('');
          }
          return;
        } else {
          document.getElementById(tableBodyID).innerHTML = "<tr><td colspan=\"4\">No teams!</td></tr>";
        }
      }

      function populateTeamSelect(dbSnapshotData, selectElemID) {
        let selectElem = document.getElementById(selectElemID);
        selectElem.innerHTML = "";
        function tempInternal(game) {
          if (dbSnapshotData[game]) {
            let teams = dbSnapshotData[game];
            let optionsTarget = "";
            for (const team in teams) {
              optionsTarget += "<option value=\"" + game + "/" + team + "\">" + game + ": " + team + "</option>";
            }
            selectElem.innerHTML += optionsTarget;
          }
        }
        tempInternal("Beat Saber");
        tempInternal("Echo Arena");
      }

      function drawCurrentTeams() {
        db.ref(currentUser.uid).once('value').then((snapshot) => {
          populateGameTable(snapshot.val(), "Beat Saber", "BSTeamTableBody");
          populateGameTable(snapshot.val(), "Echo Arena", "EATeamTableBody");
          populateTeamSelect(snapshot.val(), "teamSelect");
        });
      }

      auth.onAuthStateChanged(function (user) {
        document.getElementById("loginForm").reset();
        document.getElementById("discordForm").reset();
        if (user) {
          currentUser = user;
          db.ref(user.uid).once('value').then((snapshot) => {
            currentUserData = snapshot.val();
            try {
              document.getElementById("welcomeMsg").innerHTML = "Welcome " + currentUserData.discord.match(discordDispRegex) + "!";
              document.getElementById("discordDisp").innerHTML = currentUserData.discord;
            } catch (err) {
              document.getElementById("welcomeMsg").innerHTML = "Welcome! Please set your Discord username."
            }
            document.getElementById("unLoggedPanel").style.display = "none";
            document.getElementById("loggedPanel").style.display = "block";
            if (currentUserData.approved && currentUserData.org) {
              document.getElementById("orgDisp").innerHTML = currentUserData.org;
              document.getElementById("approvedPanel").style.display = "block";
              drawCurrentTeams();
            } else if (currentUserData.approved) {
              document.getElementById("approvedPanel").style.display = "block";
              drawCurrentTeams();
            } else if (!currentUserData.Admin) {
              document.getElementById("welcomeMsg").innerHTML += " You're still waiting on approval."
            }
            if (currentUserData.admin) {
              document.getElementById("adminPanel").style.display = "block";
            }
          });
        } else {
          currentUser = null;
          document.getElementById("welcomeMsg").innerHTML = "Login to access options & manage your teams.";
          document.getElementById("unLoggedPanel").style.display = "block";
          document.getElementById("loggedPanel").style.display = "none";
          document.getElementById("approvedPanel").style.display = "none";
          document.getElementById("adminPanel").style.display = "none";
          document.getElementById("teamCreationPanel").style.display = "none";
        }

      });
      const discordForm = document.getElementById("discordForm");
      const discordSubRegex = /^[^@#:`]{2,32}#\d{4}$/u;
      const discordDispRegex = /^[^@#:`]{2,32}/u;

      discordForm.addEventListener("submit", function (event) {
        event.preventDefault();
        let discordAttempt = document.getElementById("discordInput").value;
        if (discordSubRegex.test(discordAttempt)) {
          db.ref(currentUser.uid).update({
            discord: discordAttempt,
          });
          discordForm.reset();
          document.getElementById("welcomeMsg").innerHTML = "Welcome " + discordAttempt.match(discordDispRegex) + "!";
          if (!currentUserData.approved) {
            document.getElementById("welcomeMsg").innerHTML += " You're still waiting on approval."
          }
          document.getElementById("discordDisp").innerHTML = discordAttempt;
        } else {
          alert("The Discord username is badly formatted.");
        }
      });

      const orgForm = document.getElementById("orgForm");

      orgForm.addEventListener("submit", function (event) {
        event.preventDefault();
        let orgAttempt = document.getElementById("orgInput").value;
        if (alphaNumRegex.test(orgAttempt) && orgAttempt) {
          db.ref(currentUser.uid).update({
            org: orgAttempt,
          });
          orgForm.reset();
          document.getElementById("orgDisp").innerHTML = orgAttempt;
        } else {
          alert("The organization name is badly formatted.");
        }
      });

      // var playerListObj = {};

      // function drawPlayerTable() {
      //   let table = document.getElementById("playerTable");
      //   if (JSON.stringify(playerListObj) !== JSON.stringify({})) {
      //     table.innerHTML = "";
      //     let currentCell;
      //     for (const player in playerListObj) {
      //       table.innerHTML += "<tr><td>" + player + " (<span style=\"text-decoration: underline;\" id=" + player + ">remove</span>)" + "</tr></td>";
      //       currentCell = document.getElementById(player);
      //       currentCell.addEventListener("click", function (event) {
      //         delete playerListObj[player];
      //         drawPlayerTable();
      //       });
      //     }
      //   } else {
      //     table.innerHTML = "<tr><th>No players!</th></tr>";
      //   }
      // }


      document.getElementById("createTeamButton").addEventListener("click", function (event) {
        event.preventDefault();
        teamCreationForm.reset();
        document.getElementById("teamCreationPanel").style.display = "block";
      });

      document.getElementById("teamCreationCancel").addEventListener("click", function (event) {
        event.preventDefault();
        teamCreationForm.reset();
        document.getElementById("teamCreationPanel").style.display = "none";
      });

      // document.getElementById("addPlayerButton").addEventListener("click", function (event) {
      //   event.preventDefault();
      //   let field = document.getElementById("playerNameInput");
      //   if (alphaNumRegex.test(field.value)) {
      //     playerListObj[field.value] = { verified: false, url: "" };
      //     field.value = "";
      //     drawPlayerTable();
      //   } else { alert("Please keep player names alphanumeric."); }
      // });

      document.getElementById("saveTeamButton").addEventListener("click", function (event) {
        event.preventDefault();
        let teamNameAttempt = document.getElementById("teamNameInput").value;
        if (!teamNameAttempt) {
          alert("Please provide a team name.");
        } else if (!alphaNumRegex.test(teamNameAttempt)) {
          alert("Please keep team names alphanumeric.");
          // } else if (playerListObj.length == 0) {
          //   alert("Please add at least one player.");
        } else {
          db.ref(currentUser.uid + "/" + document.getElementById("gameSelect").value)
            .update({ [teamNameAttempt]: "No players yet!", });
          document.getElementById("teamCreationPanel").style.display = "none";
          drawCurrentTeams();
        }
      });
    });
  </script>
</body>

</html>