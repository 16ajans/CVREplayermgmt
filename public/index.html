<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>i can't do webdev</title>

  <!-- update the version number as needed -->
  <script defer src="/__/firebase/8.2.5/firebase-app.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-auth.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-database.js"></script>
  <script defer src="/__/firebase/8.2.5/firebase-storage.js"></script>

  <script defer src="/__/firebase/init.js?useEmulator=true"></script>
</head>

<body>

  <p id="welcomeMsg">Login to access options & manage your teams.</p>

  <div id="unLoggedPanel">
    <form style="display: inline;" id="loginForm">
      <label for="mailInput">Email Address:</label>
      <input id="mailInput" type="email" autocomplete="username">
      <label for="passInput">Password:</label>
      <input id="passInput" type="password" autocomplete="current-password"><br>
      <button type="submit" id="signinButton">Sign-in</button>
    </form>

    <button id="registerButton">Register</button>
    <button id="forgotButton">Forgot Password</button>
  </div>

  <div style="display: none;" id="loggedPanel">
    <button id="signoutButton">Sign-out</button>

    <p>Current Discord: <span style="font-weight: bold;" id="discordDisp">Still needs to be set.</span></p>

    <form id="discordForm">
      <label for="discordInput">Discord Username:</label>
      <input id="discordInput" type="text">
      <input type="submit" value="Submit">
    </form>

  </div>

  <div style="display: none;" id="adminPanel">
    <p>Users awaiting approval:</p>
    <table id="pendUserTable">
      <tr>
        <th>Nobody!</th>
      </tr>
    </table>
  </div>

  <div style="display: none;" id="approvedPanel">
    <p>You're approved now.</p>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {

      var currentUserData;

      firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)
        .catch((error) => {
          alert(error.message);
        });

      const auth = firebase.auth();
      const db = firebase.database();
      const stor = firebase.storage();

      document.getElementById("registerButton").addEventListener("click", function (event) {
        auth.createUserWithEmailAndPassword(document.getElementById("mailInput").value, document.getElementById("passInput").value)
          .then((userCredential) => {
            db.ref(userCredential.user.uid).set({
              approved: false,
              admin: false,
            });
          })
          .catch((error) => {
            alert(error.message);
          });
      });

      document.getElementById("signinButton").addEventListener("click", function (event) {
        event.preventDefault();
        auth.signInWithEmailAndPassword(document.getElementById("mailInput").value, document.getElementById("passInput").value)
          .catch((error) => {
            alert(error.message);
          });
      });

      document.getElementById("forgotButton").addEventListener("click", function (event) {
        auth.sendPasswordResetEmail(document.getElementById("mailInput").value).then(function () {
          alert("Sent password reset email.");
        }).catch(function (error) {
          alert(error.message);
        });
      });

      document.getElementById("signoutButton").addEventListener("click", function (event) {
        auth.signOut()
          .catch((error) => {
            alert(error.message);
          });
      });

      auth.onAuthStateChanged(function (user) {
        document.getElementById("loginForm").reset();
        document.getElementById("discordForm").reset();

        if (user) {
          db.ref(user.uid).once('value').then((snapshot) => {
            currentUserData = snapshot.val();
            try {
              document.getElementById("welcomeMsg").innerHTML = "Welcome " + currentUserData.discord.match(discordDispRegex) + "!";
              document.getElementById("discordDisp").innerHTML = currentUserData.discord;
            } catch (err) {
              document.getElementById("welcomeMsg").innerHTML = "Welcome! Please set your Discord username."
            }
            document.getElementById("unLoggedPanel").style.display = "none";
            document.getElementById("loggedPanel").style.display = "block";
            if (currentUserData.approved) {
              document.getElementById("approvedPanel").style.display = "block";
            }
            if (currentUserData.admin) {
              document.getElementById("adminPanel").style.display = "block";
            }
          });
        } else {
          document.getElementById("welcomeMsg").innerHTML = "Login to access options & manage your teams.";
          document.getElementById("unLoggedPanel").style.display = "block";
          document.getElementById("loggedPanel").style.display = "none";
          document.getElementById("approvedPanel").style.display = "none";
          document.getElementById("adminPanel").style.display = "none";
        }

      });
      const discordForm = document.getElementById("discordForm");
      const discordSubRegex = /^[^@#:`]{2,32}#\d{4}$/u;
      const discordDispRegex = /^[^@#:`]{2,32}/u;

      discordForm.addEventListener("submit", function (event) {
        event.preventDefault();
        let discordAttempt = document.getElementById("discordInput").value;
        if (discordSubRegex.test(discordAttempt)) {
          db.ref(auth.currentUser.uid).update({
            discord: discordAttempt,
          });
          discordForm.reset();
          document.getElementById("welcomeMsg").innerHTML = "Welcome " + discordAttempt.match(discordDispRegex) + "!";
          document.getElementById("discordDisp").innerHTML = discordAttempt;
        } else {
          alert("The Discord username is badly formatted.");
        }
      });

    });
  </script>
</body>

</html>